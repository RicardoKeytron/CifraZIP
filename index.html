<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <title>Ejemplo ZIP AES-256</title>

  <!-- Cargar zip.js desde la CDN (versión que soporta AES-256) -->
  <script src="https://cdn.jsdelivr.net/npm/zip.js@2.6.63/dist/zip-full.min.js"></script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      background-color: #f8f8f8;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #4a90e2;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    input[type="file"] {
      margin-top: 5px;
      margin-bottom: 15px;
    }
    input[type="password"] {
      margin-top: 5px;
      margin-bottom: 15px;
      width: 100%;
      max-width: 300px;
    }
    button {
      margin-top: 10px;
      background-color: #4caf50;
      color: #fff;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
  </style>
</head>
<body>

<h1>ZIP con AES-256</h1>

<label for="fileInput">Selecciona un fichero:</label>
<input type="file" id="fileInput">

<label for="passwordInput">Introduce una contraseña (AES-256):</label>
<input type="password" id="passwordInput" placeholder="Contraseña para el ZIP...">

<button id="zipButton">Crear ZIP cifrado</button>

<div id="status"></div>

<script>
  // Función auxiliar para mostrar mensajes en la página
  function showStatus(msg, className) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = msg;
    statusDiv.className = '';
    if (className) {
      statusDiv.classList.add(className);
    }
    statusDiv.style.display = 'block';
  }

  document.getElementById('zipButton').addEventListener('click', async () => {
    const fileInput = document.getElementById('fileInput');
    const password = document.getElementById('passwordInput').value.trim();

    // Validaciones básicas
    if (!fileInput.files[0]) {
      showStatus('Por favor, selecciona un fichero.', 'status-error');
      return;
    }
    if (!password) {
      showStatus('Por favor, introduce una contraseña.', 'status-error');
      return;
    }

    // Limpiamos mensaje anterior y procesamos
    showStatus('Creando ZIP cifrado, espera...', '');

    try {
      // 1) Leemos el archivo seleccionado
      const file = fileInput.files[0];
      const arrayBuffer = await file.arrayBuffer();
      const fileName = file.name;

      // 2) Creamos un "BlobWriter" para el zip
      const blobWriter = new zip.BlobWriter("application/zip");

      // 3) Instanciamos ZipWriter con la contraseña y encryptionStrength = 3 (AES-256)
      const zipWriter = new zip.ZipWriter(blobWriter, {
        password,
        encryptionStrength: 3  // 1->AES-128, 2->AES-192, 3->AES-256
      });

      // 4) Añadimos el archivo al ZIP
      const fileUint8 = new Uint8Array(arrayBuffer);
      await zipWriter.add(fileName, new zip.Uint8ArrayReader(fileUint8));

      // 5) Cerramos el ZipWriter
      await zipWriter.close();

      // 6) Obtenemos el Blob resultante
      const zipBlob = blobWriter.getData();

      // 7) Forzamos la descarga del ZIP
      const zipName = fileName.replace(/\.\w+$/, '') + '_AES256.zip';
      const url = URL.createObjectURL(zipBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = zipName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      showStatus(`ZIP cifrado generado: ${zipName}`, 'status-success');
    } catch (error) {
      console.error(error);
      showStatus(`Error al crear ZIP: ${error.message}`, 'status-error');
    }
  });
</script>

</body>
</html>
