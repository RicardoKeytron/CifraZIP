<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <title>Ejemplo ZIP AES-256</title>
  <script src="zip-full.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      background-color: #f8f8f8;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #4a90e2;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    input[type="file"] {
      margin-top: 5px;
      margin-bottom: 15px;
    }
    input[type="password"] {
      margin-top: 5px;
      margin-bottom: 15px;
      width: 100%;
      max-width: 300px;
    }
    button {
      margin-top: 10px;
      background-color: #4caf50;
      color: #fff;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
  </style>
</head>
<body>
  <h1>ZIP con AES-256</h1>

  <label for="fileInput">Selecciona un fichero:</label>
  <input type="file" id="fileInput">

  <label for="passwordInput">Introduce una contraseña (AES-256):</label>
  <input type="password" id="passwordInput" placeholder="Contraseña para el ZIP...">

  <button id="zipButton">Crear ZIP cifrado</button>

  <div id="status"></div>

  <script>
    // Configuración de zip.js para usar web workers (mejora el rendimiento)
    zip.configure({
      useWebWorkers: true
    });

    // Función para mostrar mensajes en pantalla
    function showStatus(msg, className) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = msg;
      statusDiv.className = '';
      if (className) {
        statusDiv.classList.add(className);
      }
      statusDiv.style.display = 'block';
    }

    document.getElementById('zipButton').addEventListener('click', async () => {
      const fileInput = document.getElementById('fileInput');
      const password = document.getElementById('passwordInput').value.trim();

      // Validaciones
      if (!fileInput.files[0]) {
        showStatus('Por favor, selecciona un fichero.', 'status-error');
        return;
      }
      if (!password) {
        showStatus('Por favor, introduce una contraseña.', 'status-error');
        return;
      }

      showStatus('Creando ZIP cifrado, espera...', '');

      try {
        // 1) Leemos el archivo
        const file = fileInput.files[0];
        const arrayBuffer = await file.arrayBuffer();
        const fileName = file.name;

        // 2) Configuración de la encriptación
        const zipConfig = {
          password: password,
          encryptionStrength: 3, // AES-256
          zipCrypto: false,      // Usar AES en lugar de ZipCrypto (algoritmo legacy)
          bufferedWrite: true,   // Mejora el rendimiento
          useWebWorkers: true    // Usa workers para no bloquear la UI
        };

        // 3) Creamos el ZIP
        const zipFileWriter = new zip.BlobWriter("application/zip");
        const zipWriter = new zip.ZipWriter(zipFileWriter, zipConfig);

        // 4) Añadimos el fichero con configuración específica para el archivo
        await zipWriter.add(fileName, new zip.Uint8ArrayReader(new Uint8Array(arrayBuffer)), {
          password: password,
          encryptionStrength: 3,
          zipCrypto: false
        });

        // 5) Cerramos y obtenemos el blob
        await zipWriter.close();
        const zipBlob = await zipFileWriter.getData();

        // 6) Nombre del archivo
        const zipName = `${fileName.split('.')[0]}_AES256.zip`;

        // 7) Descarga
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(zipBlob);
        downloadLink.download = zipName;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        
        // 8) Limpieza
        URL.revokeObjectURL(downloadLink.href);
        document.body.removeChild(downloadLink);

        showStatus(`ZIP cifrado generado: ${zipName}`, 'status-success');
      } catch (error) {
        console.error(error);
        showStatus(`Error al crear ZIP: ${error.message}`, 'status-error');
      }
    });
  </script>
</body>
</html>
